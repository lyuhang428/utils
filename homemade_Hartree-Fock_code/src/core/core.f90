! f2py -c core.f90 --f90flags="-O2" -lgsl -lgslcblas -m core => core.cpython-312-x86_64-linux-gnu.so
! mmd2.py call this Fortran module
! mmd2.py is faster than pure Python mmd.py and also faster than C wrapper.c mmd3.py

module mmd
    use, intrinsic :: iso_c_binding, only : c_int, c_double
    use omp_lib
    implicit none
    PUBLIC

    DOUBLE PRECISION, PARAMETER :: pi = 3.14159265358979323846264338_8

    interface
        function hyp1f1(a, b, c) bind(c, name="gsl_sf_hyperg_1F1")
            import                                 :: c_double
            REAL(KIND=c_double), INTENT(IN), VALUE :: a, b, c
            REAL(KIND=c_double)                    :: hyp1f1
        end function
    end interface


    CONTAINS
    function boys(n, t)
        INTEGER, INTENT(IN)          :: n
        DOUBLE PRECISION, INTENT(IN) :: t
        DOUBLE PRECISION             :: boys
        boys = hyp1f1(n + 0.5_8, n + 1.5_8, -t) / (2._8 * n + 1._8)
    end function

    recursive subroutine hermite_gauss_e(i, j, t, qx, alpha, beta, result)
        integer, intent(in)           :: i, j, t
        DOUBLE PRECISION, intent(in)  :: qx, alpha, beta
        DOUBLE PRECISION, intent(out) :: result
        DOUBLE PRECISION              :: result1, result2, result3, result4, result5, result6
        DOUBLE PRECISION              :: p, q

        result1 = 0._8
        result2 = 0._8
        result3 = 0._8
        result4 = 0._8
        result5 = 0._8
        result6 = 0._8
        p = alpha + beta
        q = alpha * beta / p

        if ((t .lt. 0) .or. (t .gt. (i + j))) then
            result = 0._8
        else if ((i .eq. 0) .and. (j .eq. 0) .and. (t .eq. 0)) then
            result = exp(-q * qx * qx)
        else if (j .eq. 0) then
            call hermite_gauss_e(i-1, j, t-1, qx, alpha, beta, result1)
            call hermite_gauss_e(i-1, j, t,   qx, alpha, beta, result2)
            call hermite_gauss_e(i-1, j, t+1, qx, alpha, beta, result3)
            result = (0.5_8 / p) * result1 - (q * qx / alpha) * result2 + (t + 1) * result3
        else
            call hermite_gauss_e(i, j-1, t-1, qx, alpha, beta, result4)
            call hermite_gauss_e(i, j-1, t,   qx, alpha, beta, result5)
            call hermite_gauss_e(i, j-1, t+1, qx, alpha, beta, result6)
            result = (0.5_8 / p) * result4 + (q * qx / beta) * result5 + (t + 1) * result6
        end if
    end subroutine hermite_gauss_e


    recursive subroutine coulomb_auxiliary_r(t, u, v, n, p, pcx, pcy, pcz, rpc, out)
        INTEGER, INTENT(IN)             :: t, u, v, n
        DOUBLE PRECISION, INTENT(IN)    :: p, pcx, pcy, pcz, rpc
        DOUBLE PRECISION, INTENT(OUT)   :: out
        DOUBLE PRECISION                :: t_, tmp1, tmp2, tmp3, tmp4, tmp5, tmp6

        t_ = p * rpc * rpc
        out = 0._8

        if (t == 0 .and. u == 0 .and. v == 0) then
            out = out + (-2._8 * p)**n * boys(n, t_)
        else if (t == 0 .and. u == 0) then
            if (v >= 2) then
                CALL coulomb_auxiliary_r(t, u, v-2, n+1, p, pcx, pcy, pcz, rpc, tmp1)
                out = out + (v - 1) * tmp1
            end if
            CALL coulomb_auxiliary_r(t, u, v-1, n+1, p, pcx, pcy, pcz, rpc, tmp2)
            out = out + pcz * tmp2
        else if (t == 0) then
            if (u >= 2) then
                CALL coulomb_auxiliary_r(t, u-2, v, n+1, p, pcx, pcy, pcz, rpc, tmp3)
                out = out + (u - 1) * tmp3
            end if
            CALL coulomb_auxiliary_r(t, u-1, v, n+1, p, pcx, pcy, pcz, rpc, tmp4)
            out = out + pcy * tmp4
        else
            if (t >= 2) then
                CALL coulomb_auxiliary_r(t-2, u, v, n+1, p, pcx, pcy, pcz, rpc, tmp5)
                out = out + (t - 1) * tmp5
            end if
            CALL coulomb_auxiliary_r(t-1, u, v, n+1, p, pcx, pcy, pcz, rpc, tmp6)
            out = out + pcx * tmp6
        end if
    end subroutine


    subroutine eri_3d(alpha, shell1, center1, &
                      beta,  shell2, center2, &
                      gamma, shell3, center3, &
                      delta, shell4, center4, out)
        REAL(KIND=8), INTENT(IN)               :: alpha, beta, gamma, delta
        REAL(KIND=8), DIMENSION(3), INTENT(IN) :: center1, center2, center3, center4
        INTEGER, DIMENSION(3), INTENT(IN)      :: shell1, shell2, shell3, shell4
        DOUBLE PRECISION, INTENT(OUT)          :: out
        REAL(KIND=8)                           :: p, q, pq, rpq
        REAL(KIND=8), DIMENSION(3)             :: centerp, centerq
        INTEGER                                :: l1, l2, l3, l4, m1, m2, m3, m4, n1, n2, n3, n4
        REAL(KIND=8)                           :: tmp1, tmp2, tmp3, tmp4, tmp5, tmp6, tmp7
        INTEGER                                :: t, u, v, tau, nu, phi

        l1 = shell1(1)
        m1 = shell1(2)
        n1 = shell1(3)

        l2 = shell2(1)
        m2 = shell2(2)
        n2 = shell2(3)

        l3 = shell3(1)
        m3 = shell3(2)
        n3 = shell3(3)

        l4 = shell4(1)
        m4 = shell4(2)
        n4 = shell4(3)

        p = alpha + beta
        q = gamma + delta
        pq = p * q / (p + q)

        centerp = (alpha * center1 + beta  * center2) / p
        centerq = (gamma * center3 + delta * center4) / q

        rpq = NORM2(centerp - centerq)

        out = 0._8

        !$OMP PARALLEL DO PRIVATE(t,u,v,tau,nu,phi,tmp1,tmp2,tmp3,tmp4,tmp5,tmp6,tmp7)
        do t = 0, l1+l2
            do u = 0, m1+m2
                do v = 0, n1+n2
                    do tau = 0, l3+l4
                        do nu = 0, m3+m4
                            do phi = 0, n3+n4
                                CALL hermite_gauss_e(l1, l2, t,   center1(1) - center2(1), alpha, beta,  tmp1)
                                CALL hermite_gauss_e(m1, m2, u,   center1(2) - center2(2), alpha, beta,  tmp2)
                                CALL hermite_gauss_e(n1, n2, v,   center1(3) - center2(3), alpha, beta,  tmp3)
                                CALL hermite_gauss_e(l3, l4, tau, center3(1) - center4(1), gamma, delta, tmp4)
                                CALL hermite_gauss_e(m3, m4, nu,  center3(2) - center4(2), gamma, delta, tmp5)
                                CALL hermite_gauss_e(n3, n4, phi, center3(3) - center4(3), gamma, delta, tmp6)
                                CALL coulomb_auxiliary_r(t+tau, u+nu, v+phi, 0, pq, centerp(1)-centerq(1), &
                                centerp(2)-centerq(2), centerp(3)-centerq(3), rpq, tmp7)
                                out = out + tmp1 * tmp2 * tmp3 * tmp4 * tmp5 * tmp6 * (-1)**(tau+nu+phi) * tmp7
                            end do
                        end do
                    end do
                end do
            end do
        end do

        out = out * 2._8 * (pi**2.5_8) / (p * q * DSQRT(p + q))
    end subroutine

    subroutine eri(coefs1, coefs2, coefs3, coefs4, & 
                   expns1, expns2, expns3, expns4, & 
                   shell1, shell2, shell3, shell4, & 
                   normalize_factors1, normalize_factors2, normalize_factors3, normalize_factors4, & 
                   center1, center2, center3, center4, res)
        REAL(KIND=8), DIMENSION(:), INTENT(IN) :: coefs1, coefs2, coefs3, coefs4
        REAL(KIND=8), DIMENSION(:), INTENT(IN) :: expns1, expns2, expns3, expns4
        REAL(KIND=8), DIMENSION(:), INTENT(IN) :: normalize_factors1, normalize_factors2, normalize_factors3, normalize_factors4
        REAL(KIND=8), DIMENSION(3), INTENT(IN) :: center1, center2, center3, center4
        INTEGER,      DIMENSION(3), INTENT(IN) :: shell1, shell2, shell3, shell4
        REAL(KIND=8), INTENT(OUT)              :: res
        INTEGER                                :: i1, i2, i3, i4
        REAL(KIND=8)                           :: tmp

        res = 0._8
        !$OMP PARALLEL DO PRIVATE(i1, i2, i3, i4, tmp)
        do i1 = 1, SIZE(coefs1)
            do i2 = 1, SIZE(coefs2)
                do i3 = 1, SIZE(coefs3)
                    do i4 = 1, SIZE(coefs4)
                        CALL eri_3d(expns1(i1), shell1, center1, & 
                                    expns2(i2), shell2, center2, & 
                                    expns3(i3), shell3, center3, & 
                                    expns4(i4), shell4, center4, tmp)
                        res = res + normalize_factors1(i1) * normalize_factors2(i2) * & 
                              normalize_factors3(i3) * normalize_factors4(i4)       * & 
                              coefs1(i1) * coefs2(i2) * coefs3(i3) * coefs4(i4)     * tmp
                    end do
                end do
            end do
        end do
    end subroutine

end module mmd


module rys
  use, intrinsic :: iso_c_binding, only: c_int, c_double
  use :: omp_lib
  implicit none

  PUBLIC

  DOUBLE PRECISION, PARAMETER :: pi = 3.14159265358979323846264338_8


  interface
      function fact(n) bind(c, name="gsl_sf_fact")
          import                                 :: c_int, c_double
          INTEGER(KIND=c_int), INTENT(IN), VALUE :: n
          REAL(KIND=c_double)                    :: fact
      end function        
  end interface    

  contains
      function binom(n, k)
        INTEGER, INTENT(IN) :: n, k
        REAL(KIND=8) :: binom
        if ( n .lt. k ) then
            ERROR STOP "binomial n must larger than or equal to k"
        end if
        binom = fact(n) / fact(k) / fact(n-k)
      end function
    

    subroutine root5(x, res)
        DOUBLE PRECISION, INTENT(IN) :: x
        
        DOUBLE PRECISION, PARAMETER ::  R15  = 1.17581320211778D-01
        DOUBLE PRECISION, PARAMETER ::  R25  = 1.07456201243690D+00
        DOUBLE PRECISION, PARAMETER ::  R35  = 3.08593744371754D+00
        DOUBLE PRECISION, PARAMETER ::  R45  = 6.41472973366203D+00
        DOUBLE PRECISION, PARAMETER ::  R55  = 1.18071894899717D+01
        DOUBLE PRECISION, PARAMETER :: PIE4  = 7.85398163397448D-01
        DOUBLE PRECISION, PARAMETER ::  W25  = 2.70967405960535D-01
        DOUBLE PRECISION, PARAMETER ::  W35  = 3.82231610015404D-02
        DOUBLE PRECISION, PARAMETER ::  W45  = 1.51614186862443D-03
        DOUBLE PRECISION, PARAMETER ::  W55  = 8.62130526143657D-06
        DOUBLE PRECISION :: RT1, RT2, RT3, RT4, RT5, WW1, WW2, WW3, WW4, WW5, E, Y, XXX
        
        DOUBLE PRECISION, DIMENSION(10), INTENT(OUT) :: res

        IF ( X .LT. 3D-7 ) THEN
            RT1 = 2.26659266316985D-02 - 2.15865967920897D-03 * X
            RT2 = 2.31271692140903D-01 - 2.20258754389745D-02 * X
            RT3 = 8.57346024118836D-01 - 8.16520023025515D-02 * X
            RT4 = 2.97353038120346D+00 - 2.83193369647137D-01 * X
            RT5 = 1.84151859759051D+01 - 1.75382723579439D+00 * X
            WW1 = 2.95524224714752D-01 - 1.96867576909777D-02 * X
            WW2 = 2.69266719309995D-01 - 5.61737590184721D-02 * X
            WW3 = 2.19086362515981D-01 - 9.71152726793658D-02 * X
            WW4 = 1.49451349150580D-01 - 1.02979262193565D-01 * X
            WW5 = 6.66713443086877D-02 - 5.73782817488315D-02 * X

        ELSE IF ( X .LT. 1._8 ) THEN
            RT1 = ((((((-4.46679165328413D-11 * X + 1.21879111988031D-09) * & 
                X - 2.62975022612104D-08) * X + 5.15106194905897D-07) * & 
                X - 9.27933625824749D-06) * X + 1.51794097682482D-04) * & 
                X - 2.15865967920301D-03) * X + 2.26659266316985D-02
        
            RT2 = ((((((1.93117331714174D-10 * X - 4.57267589660699D-09) * & 
               X + 2.48339908218932D-08) * X + 1.50716729438474D-06) * & 
               X - 6.07268757707381D-05) * X + 1.37506939145643D-03) * & 
               X - 2.20258754419939D-02) * X + 2.31271692140905D-01
        
            RT3 = (((((4.84989776180094D-09 * X + 1.31538893944284D-07) * & 
                X - 2.766753852879D-06) * X - 7.651163510626D-05)   * & 
                X + 4.033058545972D-03) * X - 8.16520022916145D-02) * & 
                X + 8.57346024118779D-01
        
            RT4 = ((((-2.48581772214623D-07 * X - 4.34482635782585D-06) * & 
              X - 7.46018257987630D-07) * X + 1.01210776517279D-02) * & 
              X - 2.83193369640005D-01) * X + 2.97353038120345D+00
        
            RT5 = (((((-8.92432153868554D-09 * X + 1.77288899268988D-08) * & 
                 X + 3.040754680666D-06) * X + 1.058229325071D-04)   * & 
                 X + 4.596379534985D-02) * X - 1.75382723579114D+00) * & 
                 X + 1.84151859759049D+01
        
            WW1 = ((((((-2.03822632771791D-09 * X + 3.89110229133810D-08) * & 
                X - 5.84914787904823D-07) * X + 8.30316168666696D-06) * & 
                X - 1.13218402310546D-04) * X + 1.49128888586790D-03) * & 
                X - 1.96867576904816D-02) * X + 2.95524224714749D-01
        
            WW2 = (((((((8.62848118397570D-09 * X - 1.38975551148989D-07) * & 
              X + 1.602894068228D-06)     * X - 1.646364300836D-05)   * & 
              X + 1.538445806778D-04)     * X - 1.28848868034502D-03) * & 
              X + 9.38866933338584D-03)   * X - 5.61737590178812D-02) * & 
              X + 2.69266719309991D-01
        
            WW3 = ((((((((-9.41953204205665D-09 * X + 1.47452251067755D-07) * & 
                  X - 1.57456991199322D-06) * X + 1.45098401798393D-05) * & 
                  X - 1.18858834181513D-04) * X + 8.53697675984210D-04) * & 
                  X - 5.22877807397165D-03) * X + 2.60854524809786D-02) * & 
                  X - 9.71152726809059D-02) * X + 2.19086362515979D-01
        
            WW4 = ((((((((-3.84961617022042D-08 * X + 5.66595396544470D-07) * & 
                  X - 5.52351805403748D-06) * X + 4.53160377546073D-05) * & 
                  X - 3.22542784865557D-04) * X + 1.95682017370967D-03) * & 
                  X - 9.77232537679229D-03) * X + 3.79455945268632D-02) * & 
                  X - 1.02979262192227D-01) * X + 1.49451349150573D-01
        
            WW5 = (((((((((4.09594812521430D-09 * X - 6.47097874264417D-08) * & 
                  X + 6.743541482689D-07)   * X - 5.917993920224D-06)   * & 
                  X + 4.531969237381D-05)   * X - 2.99102856679638D-04) * & 
                  X + 1.65695765202643D-03) * X - 7.40671222520653D-03) * & 
                  X + 2.50889946832192D-02) * X - 5.73782817487958D-02) * & 
                  X + 6.66713443086877D-02
            
        ELSE IF ( X .LT. 5._8) THEN
            Y = X - 3._8
            RT1 = ((((((((-2.58163897135138D-14 * Y + 8.14127461488273D-13) * & 
                      Y - 2.11414838976129D-11) * Y + 5.09822003260014D-10) * & 
                      Y - 1.16002134438663D-08) * Y + 2.46810694414540D-07) * & 
                      Y - 4.92556826124502D-06) * Y + 9.02580687971053D-05) * & 
                      Y - 1.45190025120726D-03) * Y + 1.73416786387475D-02
            
            RT2 = (((((((((1.04525287289788D-14   * Y + 5.44611782010773D-14) * & 
                        Y - 4.831059411392D-12)   * Y + 1.136643908832D-10)   * & 
                        Y - 1.104373076913D-09)   * Y - 2.35346740649916D-08) * & 
                        Y + 1.43772622028764D-06) * Y - 4.23405023015273D-05) * & 
                        Y + 9.12034574793379D-04) * Y - 1.52479441718739D-02) * & 
                        Y + 1.76055265928744D-01
            
            RT3 = (((((((((-6.89693150857911D-14   * Y + 5.92064260918861D-13) * & 
                         Y + 1.847170956043D-11)   * Y - 3.390752744265D-10)   * & 
                         Y - 2.995532064116D-09)   * Y + 1.57456141058535D-07) * & 
                         Y - 3.95859409711346D-07) * Y - 9.58924580919747D-05) * & 
                         Y + 3.23551502557785D-03) * Y - 5.97587007636479D-02) * & 
                         Y + 6.46432853383057D-01
            
            RT4 = ((((((((-3.61293809667763D-12 * Y - 2.70803518291085D-11) * & 
                      Y + 8.83758848468769D-10) * Y + 1.59166632851267D-08) * & 
                      Y - 1.32581997983422D-07) * Y - 7.60223407443995D-06) * & 
                      Y - 7.41019244900952D-05) * Y + 9.81432631743423D-03) * & 
                      Y - 2.23055570487771D-01) * Y + 2.21460798080643D+00
            
            RT5 = (((((((((7.12332088345321D-13   * Y + 3.16578501501894D-12) * & 
                        Y - 8.776668218053D-11)   * Y - 2.342817613343D-09)   * & 
                        Y - 3.496962018025D-08)   * Y - 3.03172870136802D-07) * & 
                        Y + 1.50511293969805D-06) * Y + 1.37704919387696D-04) * & 
                        Y + 4.70723869619745D-02) * Y - 1.47486623003693D+00) * & 
                        Y + 1.35704792175847D+01
        
            WW1 = (((((((((1.04348658616398D-13   * Y - 1.94147461891055D-12) * & 
                        Y + 3.485512360993D-11)   * Y - 6.277497362235D-10)  * & 
                        Y + 1.100758247388D-08)   * Y - 1.88329804969573D-07) * & 
                        Y + 3.12338120839468D-06) * Y - 5.04404167403568D-05) * & 
                        Y + 8.00338056610995D-04) * Y - 1.30892406559521D-02) * & 
                        Y + 2.47383140241103D-01
            
            WW2 = (((((((((((3.23496149760478D-14 * Y - 5.24314473469311D-13) * &
                            Y + 7.743219385056D-12) * Y - 1.146022750992D-10) * & 
                            Y + 1.615238462197D-09) * Y - 2.15479017572233D-08 ) * & 
                            Y + 2.70933462557631D-07) * Y - 3.18750295288531D-06) * & 
                            Y + 3.47425221210099D-05) * Y - 3.45558237388223D-04) * & 
                            Y + 3.05779768191621D-03) * Y - 2.29118251223003D-02) * & 
                            Y + 1.59834227924213D-01
            
            WW3 = ((((((((((((-3.42790561802876D-14*Y+5.26475736681542D-13) *Y- & 
                             7.184330797139D-12) *Y+9.763932908544D-11) *Y- & 
                           1.244014559219D-09) *Y+1.472744068942D-08) *Y- & 
                         1.611749975234D-07) *Y+1.616487851917D-06) *Y- & 
                       1.46852359124154D-05 ) *Y+1.18900349101069D-04 ) *Y- & 
                     8.37562373221756D-04 ) *Y+4.93752683045845D-03 ) *Y- & 
                   2.25514728915673D-02 ) *Y+6.95211812453929D-02
            
            WW4 = ((((((((((((( 1.04072340345039D-14*Y-1.60808044529211D-13) * & 
                              Y+2.183534866798D-12) *Y-2.939403008391D-11) *Y+ & 
                            3.679254029085D-10) *Y-4.23775673047899D-09 ) *Y+ & 
                          4.46559231067006D-08 ) *Y-4.26488836563267D-07 ) *Y+ & 
                        3.64721335274973D-06 ) *Y-2.74868382777722D-05 ) *Y+ & 
                      1.78586118867488D-04 ) *Y-9.68428981886534D-04 ) *Y+ & 
                    4.16002324339929D-03 ) *Y-1.28290192663141D-02 ) *Y+ & 
                    2.22353727685016D-02
            
            WW5 = ((((((((((((((-8.16770412525963D-16*Y+1.31376515047977D-14) * & 
                               Y-1.856950818865D-13) *Y+2.596836515749D-12) *Y- & 
                             3.372639523006D-11) *Y+4.025371849467D-10) *Y- & 
                           4.389453269417D-09) *Y+4.332753856271D-08) *Y- & 
                         3.82673275931962D-07 ) *Y+2.98006900751543D-06 ) *Y- & 
                       2.00718990300052D-05 ) *Y+1.13876001386361D-04 ) *Y- & 
                     5.23627942443563D-04 ) *Y+1.83524565118203D-03 ) *Y- & 
                   4.37785737450783D-03 ) *Y+5.36963805223095D-03

        ELSE IF ( X .LT. 10._8 ) THEN
            Y = X -7.5_8
            RT1 = ((((((((-1.13825201010775D-14*Y+1.89737681670375D-13) *Y- & 
                         4.81561201185876D-12 ) *Y+1.56666512163407D-10 ) *Y- & 
                       3.73782213255083D-09 ) *Y+9.15858355075147D-08 ) *Y- & 
                     2.13775073585629D-06 ) *Y+4.56547356365536D-05 ) *Y- & 
                   8.68003909323740D-04 ) *Y+1.22703754069176D-02
            
            RT2 = (((((((((-3.67160504428358D-15*Y+1.27876280158297D-14) *Y- & 
                          1.296476623788D-12) *Y+1.477175434354D-11) *Y+ & 
                        5.464102147892D-10) *Y-2.42538340602723D-08 ) *Y+ & 
                      8.20460740637617D-07 ) *Y-2.20379304598661D-05 ) *Y+ & 
                    4.90295372978785D-04 ) *Y-9.14294111576119D-03 ) *Y+ & 
                    1.22590403403690D-01
            
            RT3 = ((((((((( 1.39017367502123D-14*Y-6.96391385426890D-13) *Y+ & 
                          1.176946020731D-12) *Y+1.725627235645D-10) *Y- & 
                        3.686383856300D-09) *Y+2.87495324207095D-08 ) *Y+ & 
                      1.71307311000282D-06 ) *Y-7.94273603184629D-05 ) *Y+ & 
                    2.00938064965897D-03 ) *Y-3.63329491677178D-02 ) *Y+ & 
                    4.34393683888443D-01
            
            RT4 = ((((((((((-1.27815158195209D-14*Y+1.99910415869821D-14) *Y+ & 
                           3.753542914426D-12) *Y-2.708018219579D-11) *Y- & 
                         1.190574776587D-09) *Y+1.106696436509D-08) *Y+ & 
                       3.954955671326D-07) *Y-4.398596059588D-06) *Y- & 
                     2.01087998907735D-04 ) *Y+7.89092425542937D-03 ) *Y- & 
                   1.42056749162695D-01 ) *Y+1.39964149420683D+00
            
            RT5 = ((((((((((-1.19442341030461D-13*Y-2.34074833275956D-12) *Y+ & 
                           6.861649627426D-12) *Y+6.082671496226D-10) *Y+ & 
                         5.381160105420D-09) *Y-6.253297138700D-08) *Y- & 
                       2.135966835050D-06) *Y-2.373394341886D-05) *Y+ & 
                     2.88711171412814D-06 ) *Y+4.85221195290753D-02 ) *Y- & 
                   1.04346091985269D+00 ) *Y+7.89901551676692D+00
            
            WW1 = ((((((((( 7.95526040108997D-15*Y-2.48593096128045D-13) *Y+ & 
                          4.761246208720D-12) *Y-9.535763686605D-11) *Y+ & 
                        2.225273630974D-09) *Y-4.49796778054865D-08 ) *Y+ & 
                      9.17812870287386D-07 ) *Y-1.86764236490502D-05 ) *Y+ & 
                    3.76807779068053D-04 ) *Y-8.10456360143408D-03 ) *Y+ & 
                    2.01097936411496D-01
            
            WW2 = ((((((((((( 1.25678686624734D-15*Y-2.34266248891173D-14) *Y+ & 
                            3.973252415832D-13) *Y-6.830539401049D-12) *Y+ & 
                          1.140771033372D-10) *Y-1.82546185762009D-09 ) *Y+ & 
                        2.77209637550134D-08 ) *Y-4.01726946190383D-07 ) *Y+ & 
                      5.48227244014763D-06 ) *Y-6.95676245982121D-05 ) *Y+ & 
                    8.05193921815776D-04 ) *Y-8.15528438784469D-03 ) *Y+ & 
                    9.71769901268114D-02
            
            WW3 = ((((((((((((-8.20929494859896D-16*Y+1.37356038393016D-14) *Y- & 
                             2.022863065220D-13) *Y+3.058055403795D-12) *Y- & 
                           4.387890955243D-11) *Y+5.923946274445D-10) *Y- & 
                         7.503659964159D-09) *Y+8.851599803902D-08) *Y- & 
                       9.65561998415038D-07 ) *Y+9.60884622778092D-06 ) *Y- & 
                     8.56551787594404D-05 ) *Y+6.66057194311179D-04 ) *Y- & 
                   4.17753183902198D-03 ) *Y+2.25443826852447D-02
            
            WW4 = ((((((((((((((-1.08764612488790D-17*Y+1.85299909689937D-16) * & 
                               Y-2.730195628655D-15) *Y+4.127368817265D-14) *Y- & 
                             5.881379088074D-13) *Y+7.805245193391D-12) *Y- & 
                           9.632707991704D-11) *Y+1.099047050624D-09) *Y- & 
                         1.15042731790748D-08 ) *Y+1.09415155268932D-07 ) *Y- & 
                       9.33687124875935D-07 ) *Y+7.02338477986218D-06 ) *Y- & 
                     4.53759748787756D-05 ) *Y+2.41722511389146D-04 ) *Y- & 
                   9.75935943447037D-04 ) *Y+2.57520532789644D-03
            
            WW5 = ((((((((((((((( 7.28996979748849D-19*Y-1.26518146195173D-17) *  & 
                                Y+1.886145834486D-16) *Y-2.876728287383D-15) *Y+ & 
                              4.114588668138D-14) *Y-5.44436631413933D-13 ) *Y+ & 
                            6.64976446790959D-12 ) *Y-7.44560069974940D-11 ) *Y+ & 
                          7.57553198166848D-10 ) *Y-6.92956101109829D-09 ) *Y+ & 
                        5.62222859033624D-08 ) *Y-3.97500114084351D-07 ) *Y+ & 
                      2.39039126138140D-06 ) *Y-1.18023950002105D-05 ) *Y+ & 
                    4.52254031046244D-05 ) *Y-1.21113782150370D-04 ) *Y+ & 
                    1.75013126731224D-04

        ELSE IF ( X .LT. 15._8 ) THEN
            Y = X -12.5_8
            RT1 = ((((((((((-4.16387977337393D-17*Y+7.20872997373860D-16) *Y+ & 
                           1.395993802064D-14) *Y+3.660484641252D-14) *Y- & 
                         4.154857548139D-12) *Y+2.301379846544D-11) *Y- & 
                       1.033307012866D-09) *Y+3.997777641049D-08) *Y- & 
                     9.35118186333939D-07 ) *Y+2.38589932752937D-05 ) *Y- & 
                   5.35185183652937D-04 ) *Y+8.85218988709735D-03
            
            RT2 = ((((((((((-4.56279214732217D-16*Y+6.24941647247927D-15) *Y+ & 
                           1.737896339191D-13) *Y+8.964205979517D-14) *Y- & 
                         3.538906780633D-11) *Y+9.561341254948D-11) *Y- & 
                       9.772831891310D-09) *Y+4.240340194620D-07) *Y- & 
                     1.02384302866534D-05 ) *Y+2.57987709704822D-04 ) *Y- & 
                   5.54735977651677D-03 ) *Y+8.68245143991948D-02
            
            RT3 = ((((((((((-2.52879337929239D-15*Y+2.13925810087833D-14) *Y+ &  
                           7.884307667104D-13) *Y-9.023398159510D-13) *Y-  & 
                         5.814101544957D-11) *Y-1.333480437968D-09) *Y-  & 
                       2.217064940373D-08) *Y+1.643290788086D-06) *Y- &  
                     4.39602147345028D-05 ) *Y+1.08648982748911D-03 ) *Y- & 
                   2.13014521653498D-02 ) *Y+2.94150684465425D-01
            
            RT4 = ((((((((((-6.42391438038888D-15*Y+5.37848223438815D-15) *Y+ & 
                           8.960828117859D-13) *Y+5.214153461337D-11) *Y- & 
                         1.106601744067D-10) *Y-2.007890743962D-08) *Y+ & 
                       1.543764346501D-07) *Y+4.520749076914D-06) *Y- & 
                     1.88893338587047D-04 ) *Y+4.73264487389288D-03 ) *Y- & 
                   7.91197893350253D-02 ) *Y+8.60057928514554D-01
            
            RT5 = (((((((((((-2.24366166957225D-14*Y+4.87224967526081D-14) *Y+ & 
                            5.587369053655D-12) *Y-3.045253104617D-12) *Y- & 
                          1.223983883080D-09) *Y-2.05603889396319D-09 ) *Y+ & 
                        2.58604071603561D-07 ) *Y+1.34240904266268D-06 ) *Y- & 
                      5.72877569731162D-05 ) *Y-9.56275105032191D-04 ) *Y+ & 
                    4.23367010370921D-02 ) *Y-5.76800927133412D-01 ) *Y+ & 
                    3.87328263873381D+00
            
            WW1 = ((((((((( 8.98007931950169D-15*Y+7.25673623859497D-14) *Y+ & 
                          5.851494250405D-14) *Y-4.234204823846D-11) *Y+ & 
                        3.911507312679D-10) *Y-9.65094802088511D-09 ) *Y+ & 
                      3.42197444235714D-07 ) *Y-7.51821178144509D-06 ) *Y+ & 
                    1.94218051498662D-04 ) *Y-5.38533819142287D-03 ) *Y+ & 
                    1.68122596736809D-01
            
            WW2 = ((((((((((-1.05490525395105D-15*Y+1.96855386549388D-14) *Y- & 
                           5.500330153548D-13) *Y+1.003849567976D-11) *Y- & 
                         1.720997242621D-10) *Y+3.533277061402D-09) *Y- & 
                       6.389171736029D-08) *Y+1.046236652393D-06) *Y- & 
                     1.73148206795827D-05 ) *Y+2.57820531617185D-04 ) *Y- & 
                   3.46188265338350D-03 ) *Y+7.03302497508176D-02
            
            WW3 = ((((((((((( 3.60020423754545D-16*Y-6.24245825017148D-15) *Y+ & 
                            9.945311467434D-14) *Y-1.749051512721D-12) *Y+ & 
                          2.768503957853D-11) *Y-4.08688551136506D-10 ) *Y+ & 
                        6.04189063303610D-09 ) *Y-8.23540111024147D-08 ) *Y+ & 
                      1.01503783870262D-06 ) *Y-1.20490761741576D-05 ) *Y+ & 
                    1.26928442448148D-04 ) *Y-1.05539461930597D-03 ) *Y+ & 
                    1.15543698537013D-02
            
            WW4 = ((((((((((((( 2.51163533058925D-18*Y-4.31723745510697D-17) * & 
                              Y+6.557620865832D-16) *Y-1.016528519495D-14) *Y+ & 
                            1.491302084832D-13) *Y-2.06638666222265D-12 ) *Y+ & 
                          2.67958697789258D-11 ) *Y-3.23322654638336D-10 ) *Y+ & 
                        3.63722952167779D-09 ) *Y-3.75484943783021D-08 ) *Y+ & 
                      3.49164261987184D-07 ) *Y-2.92658670674908D-06 ) *Y+ & 
                    2.12937256719543D-05 ) *Y-1.19434130620929D-04 ) *Y+ & 
                    6.45524336158384D-04
            
            WW5 = ((((((((((((((-1.29043630202811D-19*Y+2.16234952241296D-18) * & 
                               Y-3.107631557965D-17) *Y+4.570804313173D-16) *Y- & 
                             6.301348858104D-15) *Y+8.031304476153D-14) *Y- & 
                           9.446196472547D-13) *Y+1.018245804339D-11) *Y- & 
                         9.96995451348129D-11 ) *Y+8.77489010276305D-10 ) *Y- & 
                       6.84655877575364D-09 ) *Y+4.64460857084983D-08 ) *Y- & 
                     2.66924538268397D-07 ) *Y+1.24621276265907D-06 ) *Y- & 
                   4.30868944351523D-06 ) *Y+9.94307982432868D-06
            
        ELSE IF ( X .LT. 20._8 ) THEN
            Y = X - 17.5_8
            RT1 = (((((((((( 1.91875764545740D-16 * Y + 7.8357401095707D-16) * Y - & 
                           3.260875931644D-14) * Y - 1.186752035569D-13) * Y + & 
                         4.275180095653D-12) * Y + 3.357056136731D-11) * Y - & 
                       1.123776903884D-09) * Y + 1.231203269887D-08) * Y - & 
                     3.99851421361031D-07) * Y + 1.45418822817771D-05) * Y - & 
                   3.49912254976317D-04) * Y + 6.67768703938812D-03
            
            RT2 = ((((((((((2.02778478673555D-15 * Y + 1.01640716785099D-14) * Y - & 
                           3.385363492036D-13) * Y - 1.615655871159D-12) *Y+ & 
                         4.527419140333D-11) * Y + 3.853670706486D-10) *Y- & 
                       1.184607130107D-08) * Y + 1.347873288827D-07) *Y- & 
                     4.47788241748377D-06) * Y + 1.54942754358273D-04) * Y - & 
                   3.55524254280266D-03) * Y + 6.44912219301603D-02
            
            RT3 = (((((((((( 7.79850771456444D-15 * Y + 6.00464406395001D-14) * Y - & 
                           1.249779730869D-12) * Y - 1.020720636353D-11) * Y + & 
                         1.814709816693D-10) * Y + 1.766397336977D-09) * Y - & 
                       4.603559449010D-08) * Y + 5.863956443581D-07) * Y - & 
                     2.03797212506691D-05) * Y + 6.31405161185185D-04) * Y - & 
                   1.30102750145071D-02) * Y + 2.10244289044705D-01
            
            RT4 = (((((((((((-2.92397030777912D-15 * Y + 1.94152129078465D-14) * Y + & 
                    4.859447665850D-13) * Y - 3.217227223463D-12) * Y - & 
                    7.484522135512D-11) * Y + 7.19101516047753D-10 ) * Y + & 
                    6.88409355245582D-09) * Y - 1.44374545515769D-07 ) * Y + & 
                    2.74941013315834D-06) * Y - 1.02790452049013D-04 ) * Y + & 
                    2.59924221372643D-03) * Y - 4.35712368303551D-02) * Y + & 
                    5.62170709585029D-01
            
            RT5 = ((((((((((( 1.17976126840060D-14 * Y + 1.24156229350669D-13) * Y - & 
                            3.892741622280D-12) * Y - 7.755793199043D-12) * Y + & 
                          9.492190032313D-10) * Y - 4.98680128123353D-09 ) * Y - & 
                        1.81502268782664D-07) * Y + 2.69463269394888D-06 ) * Y + & 
                      2.50032154421640D-05) * Y - 1.33684303917681D-03 ) * Y + & 
                    2.29121951862538D-02) * Y - 2.45653725061323D-01) * Y + & 
                    1.89999883453047D+00
            
            WW1 = (((((((((( 1.74841995087592D-15 * Y - 6.95671892641256D-16) * Y - & 
                           3.000659497257D-13) * Y + 2.021279817961D-13) * Y + & 
                         3.853596935400D-11) * Y + 1.461418533652D-10) * Y - & 
                       1.014517563435D-08) * Y + 1.132736008979D-07) * Y - & 
                     2.86605475073259D-06) * Y + 1.21958354908768D-04) * Y - & 
                   3.86293751153466D-03) * Y + 1.45298342081522D-01
            
            WW2 = ((((((((((-1.11199320525573D-15 * Y + 1.85007587796671D-15) * Y + & 
                           1.220613939709D-13) * Y + 1.275068098526D-12) * Y - & 
                         5.341838883262D-11) * Y + 6.161037256669D-10) * Y - & 
                       1.009147879750D-08) * Y + 2.907862965346D-07) * Y - & 
                     6.12300038720919D-06) * Y + 1.00104454489518D-04) * Y - & 
                   1.80677298502757D-03) * Y + 5.78009914536630D-02
            
            WW3 = ((((((((((-9.49816486853687D-16*Y+6.67922080354234D-15) * Y+ & 
                           2.606163540537D-15) *Y+1.983799950150D-12) *Y- & 
                         5.400548574357D-11) *Y+6.638043374114D-10) *Y- & 
                       8.799518866802D-09) *Y+1.791418482685D-07) *Y- & 
                     2.96075397351101D-06) *Y+3.38028206156144D-05) *Y- &  
                   3.58426847857878D-04) *Y+8.39213709428516D-03
            
            WW4 = ((((((((((( 1.33829971060180D-17*Y-3.44841877844140D-16) *Y+ & 
                            4.745009557656D-15) *Y-6.033814209875D-14) *Y+ & 
                          1.049256040808D-12) *Y-1.70859789556117D-11) *Y+ & 
                        2.15219425727959D-10) *Y-2.52746574206884D-09) *Y+ & 
                      3.27761714422960D-08) *Y-3.90387662925193D-07) *Y+ & 
                    3.46340204593870D-06) *Y-2.43236345136782D-05) *Y+ & 
                    3.54846978585226D-04
            
            WW5 = ((((((((((((( 2.69412277020887D-20*Y-4.24837886165685D-19) * & 
                              Y+6.030500065438D-18) *Y-9.069722758289D-17) *Y+ & 
                            1.246599177672D-15) *Y-1.56872999797549D-14) *Y+ & 
                          1.87305099552692D-13) *Y-2.09498886675861D-12) *Y+ & 
                        2.11630022068394D-11) *Y-1.92566242323525D-10) *Y+ & 
                      1.62012436344069D-09) *Y-1.23621614171556D-08) *Y+ & 
                    7.72165684563049D-08) *Y-3.59858901591047D-07) *Y+ & 
                    2.43682618601000D-06
    
        ELSE IF ( X .LT. 25._8 ) THEN
            Y = X - 22.5_8
            RT1 = (((((((((-1.13927848238726D-15 * Y + 7.39404133595713D-15) * & 
                          Y + 1.445982921243D-13) * Y - 2.676703245252D-12) * & 
                          Y + 5.823521627177D-12) * Y + 2.17264723874381D-10) * & 
                          Y + 3.56242145897468D-09) * Y - 3.03763737404491D-07) * & 
                          Y + 9.46859114120901D-06) * Y - 2.30896753853196D-04) * & 
                          Y + 5.24663913001114D-03
            
            RT2 = ((((((((((2.89872355524581D-16 * Y - 1.22296292045864D-14) * & 
                           Y + 6.184065097200D-14) * Y + 1.649846591230D-12) * & 
                           Y - 2.729713905266D-11) * Y + 3.709913790650D-11) * & 
                           Y + 2.216486288382D-09) * Y + 4.616160236414D-08) * & 
                           Y - 3.32380270861364D-06) * Y + 9.84635072633776D-05) * & 
                           Y - 2.30092118015697D-03 ) *Y+5.00845183695073D-02
            
            RT3 = ((((((((((1.97068646590923D-15 * Y - 4.89419270626800D-14) * & 
                           Y + 1.136466605916D-13) * Y + 7.546203883874D-12) * & 
                           Y - 9.635646767455D-11) * Y - 8.295965491209D-11) * & 
                           Y + 7.534109114453D-09) * Y + 2.699970652707D-07) * & 
                           Y - 1.42982334217081D-05) * Y + 3.78290946669264D-04 ) * & 
                           Y - 8.03133015084373D-03) * Y + 1.58689469640791D-01
            
            RT4 = (((((((((( 1.33642069941389D-14 * Y - 1.55850612605745D-13) * & 
                           Y - 7.522712577474D-13) * Y + 3.209520801187D-11) * & 
                           Y - 2.075594313618D-10) * Y - 2.070575894402D-09) * & 
                           Y + 7.323046997451D-09) * Y + 1.851491550417D-06) * & 
                           Y - 6.37524802411383D-05) * Y + 1.36795464918785D-03) * & 
                           Y - 2.42051126993146D-02) * Y + 3.97847167557815D-01
            
            RT5 = ((((((((((-6.07053986130526D-14*Y+1.04447493138843D-12) * Y - &
                               4.286617818951D-13) *Y-2.632066100073D-10) * Y + &
                               4.804518986559D-09) *Y-1.835675889421D-08) * Y - &
                               1.068175391334D-06) *Y+3.292234974141D-05) * Y - &
                               5.94805357558251D-04) *Y+8.29382168612791D-03) * Y - &
                               9.93122509049447D-02) *Y+1.09857804755042D+00
            
            WW1 = (((((((((-9.10338640266542D-15 * Y + 1.00438927627833D-13) * Y + &
                          7.817349237071D-13) * Y - 2.547619474232D-11) * Y + &
                        1.479321506529D-10) * Y + 1.52314028857627D-09 ) * Y + &
                      9.20072040917242D-09) * Y - 2.19427111221848D-06 ) * Y + &
                    8.65797782880311D-05) * Y - 2.82718629312875D-03 ) * Y + &
                    1.28718310443295D-01
            
            WW2 = ((((((((( 5.52380927618760D-15 * Y - 6.43424400204124D-14) * Y - &
                          2.358734508092D-13) * Y + 8.261326648131D-12) * Y + &
                        9.229645304956D-11) * Y - 5.68108973828949D-09) * Y + &
                      1.22477891136278D-07) * Y - 2.11919643127927D-06) * Y + &
                    4.23605032368922D-05) * Y - 1.14423444576221D-03) * Y + &
                    5.06607252890186D-02
            
            WW3 = ((((((((( 3.99457454087556D-15 * Y - 5.11826702824182D-14) * Y - & 
                          4.157593182747D-14) * Y + 4.214670817758D-12) * Y + & 
                        6.705582751532D-11) * Y - 3.36086411698418D-09 ) * Y + & 
                      6.07453633298986D-08) * Y - 7.40736211041247D-07 ) * Y + & 
                    8.84176371665149D-06) * Y - 1.72559275066834D-04 ) * Y + & 
                    7.16639814253567D-03
            
            WW4 = (((((((((((-2.14649508112234D-18 * Y - 2.45525846412281D-18) * Y + & 
                            6.126212599772D-16) * Y - 8.526651626939D-15) * Y + & 
                          4.826636065733D-14) * Y - 3.39554163649740D-13 ) * Y + & 
                        1.67070784862985D-11) * Y - 4.42671979311163D-10 ) * Y + & 
                      6.77368055908400D-09) * Y - 7.03520999708859D-08 ) * Y + & 
                    6.04993294708874D-07) * Y - 7.80555094280483D-06 ) * Y + & 
                    2.85954806605017D-04
            
            WW5 = ((((((((((((-5.63938733073804D-21 * Y + 6.92182516324628D-20) * Y- & 
                             1.586937691507D-18) * Y + 3.357639744582D-17) * Y - & 
                           4.810285046442D-16) * Y + 5.386312669975D-15) * Y - & 
                         6.117895297439D-14) * Y + 8.441808227634D-13) * Y - & 
                       1.18527596836592D-11) * Y + 1.36296870441445D-10 ) * Y - &  
                     1.17842611094141D-09) * Y + 7.80430641995926D-09) * Y - & 
                   5.97767417400540D-08) * Y + 1.65186146094969D-06
    
        ELSE IF ( X .LT. 40._8 ) THEN
            WW1 = SQRT(PIE4 / X)
            E = EXP(-X)
            RT1 = ((((((((-1.73363958895356D-06 * X + 1.19921331441483D-04) * & 
                         X - 1.59437614121125D-02) * X + 1.13467897349442D+00) * & 
                         X - 4.47216460864586D+01) * X + 1.06251216612604D+03) * & 
                         X - 1.52073917378512D+04) * X + 1.20662887111273D+05) * & 
                         X - 4.07186366852475D+05) * E + R15 / (X - R15)
            
            RT2 = ((((((((-1.60102542621710D-05 * X + 1.10331262112395D-03) * & 
                         X - 1.50043662589017D-01) * X + 1.05563640866077D+01) * & 
                         X - 4.10468817024806D+02) * X + 9.62604416506819D+03) * & 
                         X - 1.35888069838270D+05) * X + 1.06107577038340D+06) * & 
                         X - 3.51190792816119D+06) * E + R25 / (X - R25)
            
            RT3 = ((((((((-4.48880032128422D-05 * X + 2.69025112122177D-03) * & 
                         X - 4.01048115525954D-01) * X + 2.78360021977405D+01) * & 
                         X - 1.04891729356965D+03) * X + 2.36985942687423D+04) * & 
                         X - 3.19504627257548D+05) * X + 2.34879693563358D+06) * & 
                         X - 7.16341568174085D+06) * E + R35 / (X - R35)
            
            RT4 = ((((((((-6.38526371092582D-05 * X - 2.29263585792626D-03) * & 
                         X - 7.65735935499627D-02) * X + 9.12692349152792D+00) * & 
                         X - 2.32077034386717D+02) * X + 2.81839578728845D+02) * & 
                         X + 9.59529683876419D+04) * X - 1.77638956809518D+06) * & 
                         X + 1.02489759645410D+07) * E + R45 / (X - R45)
            
            RT5 = ((((((((-3.59049364231569D-05 * X - 2.25963977930044D-02) * & 
                         X + 1.12594870794668D+00) * X - 4.56752462103909D+01) * & 
                         X + 1.05804526830637D+03) * X - 1.16003199605875D+04) * & 
                         X - 4.07297627297272D+04) * X + 2.22215528319857D+06) * & 
                         X - 1.61196455032613D+07) * E + R55 / (X - R55)
            
            WW5 = (((((((((-4.61100906133970D-10 * X + 1.43069932644286D-07) * & 
                          X - 1.63960915431080D-05) * X + 1.15791154612838D-03) * & 
                          X - 5.30573476742071D-02) * X + 1.61156533367153D+00) * & 
                          X - 3.23248143316007D+01) * X + 4.12007318109157D+02) * & 
                          X - 3.02260070158372D+03) * X + 9.71575094154768D+03) * & 
                          E + W55 * WW1
            
            WW4 = (((((((((-2.40799435809950D-08 * X + 8.12621667601546D-06) * & 
                          X - 9.04491430884113D-04) * X + 6.37686375770059D-02) * & 
                          X - 2.96135703135647D+00) * X + 9.15142356996330D+01) * & 
                          X - 1.86971865249111D+03) * X + 2.42945528916947D+04) * & 
                          X - 1.81852473229081D+05) * X + 5.96854758661427D+05) * & 
                          E + W45 * WW1
            
            WW3 = ((((((((1.83574464457207D-05 * X - 1.54837969489927D-03) * & 
                         X + 1.18520453711586D-01) * X - 6.69649981309161D+00) * & 
                         X + 2.44789386487321D+02) * X - 5.68832664556359D+03) * & 
                         X + 8.14507604229357D+04) * X - 6.55181056671474D+05) * & 
                         X + 2.26410896607237D+06) * E + W35 * WW1
            
            WW2 = ((((((((2.77778345870650D-05 * X - 2.22835017655890D-03) * & 
                         X + 1.61077633475573D-01) * X - 8.96743743396132D+00) * & 
                         X + 3.28062687293374D+02) * X - 7.65722701219557D+03) * & 
                         X + 1.10255055017664D+05) * X - 8.92528122219324D+05) * & 
                         X + 3.10638627744347D+06) * E + W25 * WW1
            
            WW1 = WW1 - 0.01962_8 * E - WW2 - WW3 - WW4 - WW5
    
        ELSE IF ( X .LT. 59._8 ) THEN
            WW1 = SQRT(PIE4 / X)
            XXX = X**3
            E = XXX * EXP(-X)
            RT1 = (((-2.43758528330205D-02    * X + 2.07301567989771D+00) * & 
                    X - 6.45964225381113D+01) * X + 7.14160088655470D+02) * & 
                    E + R15 / (X - R15)
            
            RT2 = (((-2.28861955413636D-01 * X + 1.93190784733691D+01) * & 
                    X - 5.99774730340912D+02) * X + 6.61844165304871D+03) * & 
                    E + R25 / (X - R25)
            
            RT3 = (((-6.95053039285586D-01 * X + 5.76874090316016D+01) * & 
                    X - 1.77704143225520D+03) * X + 1.95366082947811D+04) * E + R35 / (X -R35)
            
            RT4 = (((-1.58072809087018D+00 * X + 1.27050801091948D+02) * & 
                    X - 3.86687350914280D+03) * X + 4.23024828121420D+04) * & 
                    E + R45 / (X - R45)
            
            RT5 = (((-3.33963830405396D+00 * X + 2.51830424600204D+02) * & 
                    X - 7.57728527654961D+03) * X + 8.21966816595690D+04) * E + R55 / (X - R55)
            
            E = XXX * E
            WW5 = ((1.35482430510942D-08 * X - 3.27722199212781D-07) * & 
                   X + 2.41522703684296D-06) * E + W55 * WW1
            
            WW4 = ((1.23464092261605D-06 * X - 3.55224564275590D-05) * & 
                   X + 3.03274662192286D-04) * E + W45 * WW1
            
            WW3 = ((1.34547929260279D-05 * X - 4.19389884772726D-04) * & 
                   X + 3.87706687610809D-03) * E + W35 * WW1
            
            WW2 = ((2.09539509123135D-05 * X - 6.87646614786982D-04) * & 
                   X + 6.68743788585688D-03) * E + W25 * WW1
            WW1 = WW1 - WW2 - WW3 - WW4 - WW5

        ELSE
            WW1 = SQRT(PIE4 / X)
            RT1 = R15 / (X - R15)
            RT2 = R25 / (X - R25)
            RT3 = R35 / (X - R35)
            RT4 = R45 / (X - R45)
            RT5 = R55 / (X - R55)
            WW2 = W25 * WW1
            WW3 = W35 * WW1
            WW4 = W45 * WW1
            WW5 = W55 * WW1
            WW1 = WW1 - WW2 - WW3 - WW4 - WW5
        END IF

        res = (/RT1 / (1._8 + RT1), RT2 / (1._8 + RT2), RT3 / (1._8 + RT3), RT4 / (1._8 + RT4), RT5 / (1._8 + RT5), & 
                WW1, WW2, WW3, WW4, WW5/)
    end subroutine


    subroutine recur(li,    lj,   lk,    ll, & 
                     xi,    xj,   xk,    xl, & 
                     alpha, beta, gamma, delta, t, g_)
        INTEGER     , INTENT(IN)               :: li, lj, lk, ll
        REAL(KIND=8), INTENT(IN)               :: xi, xj, xk, xl
        REAL(KIND=8), INTENT(IN)               :: alpha, beta, gamma, delta
        REAL(KIND=8), INTENT(IN)               :: t
        REAL(KIND=8)                           :: a_, b_, xa, xb, ix0, b00, b10, b10p, c00, c00p
        INTEGER                                :: ii, jj, aa, bb
        REAL(KIND=8), ALLOCATABLE :: gg_(:,:)
        REAL(KIND=8), DIMENSION(:,:), INTENT(OUT) :: g_

        a_ = alpha + beta
        b_ = gamma + delta
        xa = (alpha * xi + beta  * xj) / (alpha + beta )
        xb = (gamma * xk + delta * xl) / (gamma + delta)
        ix0 = pi / SQRT(a_ * b_) * & 
              EXP(-alpha * beta / (alpha + beta) * (xi - xj)**2 - & 
                  gamma * delta / (gamma + delta) * (xk - xl)**2)
        b00  = 0.5_8 / (a_ + b_) * t
        b10  = 0.5_8 / a_ - 0.5_8 * b_ / a_ / (a_ + b_) * t
        b10p = 0.5_8 / b_ - 0.5_8 * a_ / b_ / (a_ + b_) * t
        c00  = (xa - xi) + b_ / (a_ + b_) * (xb - xa)   * t
        c00p = (xb - xk) + a_ / (a_ + b_) * (xa - xb)   * t

        ALLOCATE(gg_(0:li+lj, 0:lk+ll))
        gg_ = 0._8
        gg_(0, 0) = ix0

        if ( li + lj .gt. 0 ) then
            gg_(1,0) = c00 * gg_(0,0)
        end if

        if ( lk + ll .gt. 0 ) then
            gg_(0,1) = c00p * gg_(0,0)
        end if

        do ii = 1, li+lj-1
            gg_(ii+1, 0) = ii * b10 * gg_(ii-1, 0) + c00 * gg_(ii, 0)
        end do

        do jj = 1, lk+ll-1
            gg_(0, jj+1) = jj * b10p * gg_(0, jj-1) + c00p * gg_(0, jj)
        end do

        if ( (li + lj .eq. 0) .or. (lk + ll .eq. 0) ) then
            g_ = gg_
            RETURN
        end if

        do aa = 1, li+lj
            gg_(aa, 1) = aa * b00 * gg_(aa-1, 0) + c00p * gg_(aa, 0)
            do bb = 2, lk+ll
                gg_(aa, bb) = b10p * (bb - 1) * gg_(aa, bb-2) + & 
                             aa * b00 * gg_(aa-1, bb-1) + & 
                             c00p * gg_(aa, bb-1)
            end do
        end do
        g_ = gg_
    end subroutine


    subroutine shift(g_, li, lk, xij, xkl, res)
        DOUBLE PRECISION, DIMENSION(:,:), INTENT(IN) :: g_
        INTEGER, INTENT(IN)                          :: li, lk
        DOUBLE PRECISION, INTENT(IN)                 :: xij, xkl
        DOUBLE PRECISION                             :: tmp
        INTEGER, DIMENSION(0:1)                      :: dims
        INTEGER                                      :: lj, ll
        INTEGER                                      :: m, n
        DOUBLE PRECISION, INTENT(OUT)                :: res

        dims = SHAPE(g_)
        lj = dims(0) - li - 1
        ll = dims(1) - lk - 1

        res = 0._8
        do m = 0, ll
            tmp = 0._8
            do n = 0, lj
                tmp = tmp + binom(lj, n) * xij**(lj-n) * g_(n+li+1, m+lk+1)
            end do
            res = res + binom(ll, m) * xkl**(ll-m) * tmp
        end do
    end subroutine


    subroutine ix(l1, l2, l3, l4, & 
                  x1, x2, x3, x4, &
                  alpha, beta, gamma, delta, t, ix_)
        INTEGER         , INTENT(IN)  :: l1, l2, l3, l4
        DOUBLE PRECISION, INTENT(IN)  :: x1, x2, x3, x4
        DOUBLE PRECISION, INTENT(IN)  :: alpha, beta, gamma, delta
        DOUBLE PRECISION, INTENT(IN)  :: t
        double PRECISION, DIMENSION(l1+l2+1, l3+l4+1) :: g_
        DOUBLE PRECISION, INTENT(OUT) :: ix_
    
        CALL recur(l1, l2, l3, l4, x1, x2, x3, x4, alpha, beta, gamma, delta, t, g_)
        CALL shift(g_, l1, l3, x1-x2, x3-x4, ix_)
    end subroutine


    subroutine eri_3d_rys(l1, m1, n1, & 
                          l2, m2, n2, & 
                          l3, m3, n3, & 
                          l4, m4, n4, & 
                          x1, y1, z1, & 
                          x2, y2, z2, & 
                          x3, y3, z3, & 
                          x4, y4, z4, & 
                          alpha, beta, gamma, delta, res)
        INTEGER, INTENT(IN)             :: l1, m1, n1
        INTEGER, INTENT(IN)             :: l2, m2, n2
        INTEGER, INTENT(IN)             :: l3, m3, n3
        INTEGER, INTENT(IN)             :: l4, m4, n4
        DOUBLE PRECISION, INTENT(IN)    :: x1, y1, z1
        DOUBLE PRECISION, INTENT(IN)    :: x2, y2, z2
        DOUBLE PRECISION, INTENT(IN)    :: x3, y3, z3
        DOUBLE PRECISION, INTENT(IN)    :: x4, y4, z4
        DOUBLE PRECISION, INTENT(IN)    :: alpha, beta, gamma, delta
        DOUBLE PRECISION                :: a_, b_, rho
        DOUBLE PRECISION, DIMENSION(3)  :: centerp, centerq
        DOUBLE PRECISION                :: rpq2, x_
        DOUBLE PRECISION, DIMENSION(5)  :: roots, weights
        DOUBLE PRECISION, DIMENSION(10) :: roots_and_weights
        INTEGER                         :: idx
        DOUBLE PRECISION                :: ix_, iy_, iz_
        DOUBLE PRECISION, INTENT(OUT)   :: res

        a_ = alpha + beta
        b_ = gamma + delta
        rho = a_ * b_ / (a_ + b_)
        centerp = (alpha * (/x1, y1, z1/) + beta  * (/x2, y2, z2/)) / (alpha + beta )
        centerq = (gamma * (/x3, y3, z3/) + delta * (/x4, y4, z4/)) / (gamma + delta)
        rpq2 = (centerp(1) - centerq(1))**2 + (centerp(2) - centerq(2))**2 + (centerp(3) - centerq(3))**2
        x_ = rpq2 * rho

        CALL root5(x_, roots_and_weights)
        roots = roots_and_weights(1:5)
        weights = roots_and_weights(6:10)

        res = 0._8
        do idx = 1, SIZE(roots)
            CALL ix(l1, l2, l3, l4, x1, x2, x3, x4, alpha, beta, gamma, delta, roots(idx), ix_)
            CALL ix(m1, m2, m3, m4, y1, y2, y3, y4, alpha, beta, gamma, delta, roots(idx), iy_)
            CALL ix(n1, n2, n3, n4, z1, z2, z3, z4, alpha, beta, gamma, delta, roots(idx), iz_)
            res = res + ix_ * iy_ * iz_ * weights(idx)
        end do
        res = res * 2._8 * SQRT(rho / pi)
    end subroutine


    subroutine eri_rys(coefs1, coefs2, coefs3, coefs4, & 
                       expns1, expns2, expns3, expns4, & 
                       shell1, shell2, shell3, shell4, & 
                       normalize_factors1, normalize_factors2, normalize_factors3, normalize_factors4, & 
                       center1, center2, center3, center4, res)
        DOUBLE PRECISION, DIMENSION(:), INTENT(IN) :: coefs1, coefs2, coefs3, coefs4
        DOUBLE PRECISION, DIMENSION(:), INTENT(IN) :: expns1, expns2, expns3, expns4
        DOUBLE PRECISION, DIMENSION(:), INTENT(IN) :: normalize_factors1, normalize_factors2, normalize_factors3, normalize_factors4
        DOUBLE PRECISION, DIMENSION(3), INTENT(IN) :: center1, center2, center3, center4
        INTEGER         , DIMENSION(3), INTENT(IN) :: shell1, shell2, shell3, shell4
        INTEGER                                    :: i1, i2, i3, i4
        DOUBLE PRECISION                           :: tmp
        DOUBLE PRECISION, INTENT(OUT)              :: res

        res = 0._8
        do i1 = 1, SIZE(coefs1)
          do i2 = 1, SIZE(coefs2)
            do i3 = 1, SIZE(coefs3)
              do i4 = 1, SIZE(coefs4)
                CALL eri_3d_rys( shell1(1),  shell1(2),  shell1(3), & 
                                 shell2(1),  shell2(2),  shell2(3), & 
                                 shell3(1),  shell3(2),  shell3(3), & 
                                 shell4(1),  shell4(2),  shell4(3), & 
                                center1(1), center1(2), center1(3), & 
                                center2(1), center2(2), center2(3), & 
                                center3(1), center3(2), center3(3), & 
                                center4(1), center4(2), center4(3), & 
                                expns1(i1), expns2(i2), expns3(i3), expns4(i4), tmp)
                  res = res + normalize_factors1(i1) * normalize_factors2(i2) * & 
                        normalize_factors3(i3)  * normalize_factors4(i4)      * & 
                        coefs1(i1) * coefs2(i2) * coefs3(i3) * coefs4(i4)     * tmp
              end do
            end do
          end do
        end do
    end subroutine
      
end module rys


